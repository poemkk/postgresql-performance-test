Итоговый отчет по тестированию и оптимизации производительности PostgreSQL в виртуализированной среде
Содержание

Введение
1.1 Предпосылки исследования
1.2 Цели и задачи
1.3 Обзор технологий


Этап 1: Выбор инструментов, установка и начальная конфигурация
2.1 Выбор платформы виртуализации
2.2 Выбор СУБД
2.3 Выбор операционных систем для виртуальных машин
2.4 Конфигурация виртуальных машин
2.5 Установка PostgreSQL
2.6 Настройка HammerDB
2.7 Документирование конфигурации


Этап 2: Сравнение производительности на разных ОС
3.1 Методология тестирования
3.2 Результаты тестирования
3.3 Анализ использования ресурсов
3.4 Сравнение производительности и выводы


Этап 3: Тестирование оптимизации параметров виртуальной машины
4.1 Методология тестирования
4.2 Результаты тестирования
4.3 Анализ использования ресурсов
4.4 Тенденции производительности и анализ узких мест
4.5 Определение оптимальной конфигурации


Выводы и рекомендации
5.1 Общие выводы
5.2 Рекомендации для производственной среды
5.3 Направления будущих тестов


Список литературы
Приложения

1 Введение
1.1 Предпосылки исследования
Технологии виртуализации широко применяются в современных информационных системах, обеспечивая гибкость и эффективное использование ресурсов. Однако производительность систем управления базами данных (СУБД) в виртуализированных средах зависит от множества факторов, включая платформу виртуализации, конфигурацию виртуальных машин, операционную систему и настройки СУБД. Инструменты нагрузочного тестирования, такие как HammerDB, позволяют оценивать и оптимизировать производительность СУБД. Данное исследование направлено на анализ производительности PostgreSQL в различных операционных системах и конфигурациях виртуальных машин с целью определения оптимальных параметров.
1.2 Цели и задачи

Цель: Освоить технологии виртуализации, развертывания СУБД и нагрузочного тестирования, оптимизировать производительность PostgreSQL в виртуализированной среде.
Задачи:
Выбрать и настроить платформу виртуализации, СУБД и инструмент нагрузочного тестирования.
Развернуть PostgreSQL на виртуальных машинах с Windows 11 и Ubuntu 22.04 LTS, сравнить производительность.
Оптимизировать конфигурацию виртуальной машины (vCPU и RAM), определить оптимальные параметры.
Задокументировать процесс тестирования, результаты и анализ.



1.3 Обзор технологий

Платформа виртуализации: Parallels Desktop 19.3.0, оптимизированная для Apple Silicon.
СУБД: PostgreSQL 16.8, поддерживает архитектуру ARM64, предоставляет мощные инструменты диагностики производительности.
Инструмент нагрузочного тестирования: HammerDB 4.10, использует шаблон TPROC-C для имитации OLTP-нагрузки.
Операционные системы: Ubuntu 22.04.4 LTS и Windows 11 23H2, обе версии ARM64.

2 Этап 1: Выбор инструментов, установка и начальная конфигурация
2.1 Выбор платформы виртуализации

Выбор: Parallels Desktop 19.3.0 (версия для ARM).
Обоснование:
Оптимизированная производительность виртуализации для ARM, совместимость с чипами Apple M-series.
Поддержка Guest Additions для улучшения интеграции с Windows и Linux.
Низкая совместимость VirtualBox с Apple Silicon.


Конфигурация хоста:
macOS 15.4.1 (Sonoma)
Apple M2 Pro (12 ядер CPU, 19 ядер GPU)
32 ГБ унифицированной памяти
1 ТБ NVMe SSD



2.2 Выбор СУБД

Выбор: PostgreSQL 16.8 (ARM64).
Обоснование:
Кроссплатформенная согласованность.
Мощные инструменты диагностики производительности.
Нативная поддержка архитектуры ARM.


Контроль версий:PostgreSQL 16.8 (ARM64)



2.3 Выбор операционных систем для виртуальных машин



Параметр
Виртуальная машина Linux
Виртуальная машина Windows



Версия
Ubuntu 22.04.4 LTS (ARM64)
Windows 11 23H2 (ARM64)


Разрядность
64-bit
64-bit


Ключевые компоненты
Минимальная установка
Режим разработчика


2.4 Конфигурация виртуальных машин

Аппаратные параметры:- vCPU: 2 ядра
- RAM: 4 ГБ DDR5
- Диск: динамический, 64 ГБ
- Сеть: режим моста


Установка дополнений:# Ubuntu
sudo apt install parallels-tools
# Windows
Автоматическая установка Parallels Tools



2.5 Установка PostgreSQL

Ubuntu:sudo apt install postgresql-16
sudo systemctl enable postgresql


Windows:choco install postgresql16


Проверка:SELECT version(); -- Возвращает: PostgreSQL 16.8 on arm64



2.6 Настройка HammerDB

Версия: HammerDB 4.10 для macOS.
Тестовый скрипт: TPROC-C (стандартный шаблон).
Ключевые настройки:[Database]
Connection Timeout=60000
[Virtual Users]
Count=8
Rampup=120



2.7 Документирование конфигурации
# Базовый конфигурационный снимок
Дата: 16 мая 2025 г.

## Аппаратные параметры
| Компонент       | Хост       | Виртуальная машина Ubuntu | Виртуальная машина Windows |
|-----------------|------------|--------------------------|--------------------------|
| Архитектура     | ARM64      | ARM64                    | ARM64                    |

## Версии ПО
- Parallels Desktop: 19.3.0
- PostgreSQL: 16.8
- Ubuntu: 22.04.4 LTS
- Windows: 11 23H2

3 Этап 2: Сравнение производительности на разных ОС
3.1 Методология тестирования

Платформа виртуализации: Parallels Desktop 19.3.0.
Конфигурация виртуальных машин:
Ubuntu: 6 vCPU, 4 ГБ RAM, 64 ГБ динамический диск.
Windows: 6 vCPU, 16 ГБ RAM, SSD (интерфейс SATA).


Настройки HammerDB:[TPROC-C Profile]
Virtual Users = 3-4
Rampup Time = 120 sec
Duration = 600 sec
Warehouses = 10
Think Time = 5000ms


Процесс тестирования:
Каждый тест проводился 2-3 раза, результаты усреднялись.
Использовались утилиты top (Ubuntu) и Монитор ресурсов (Windows) для мониторинга ресурсов.



3.2 Результаты тестирования



Параметр
Ubuntu 22.04 LTS
Windows 11 (диапазон)



TPM
183,403
127,573–153,038


NOPM
79,805
55,408–68,550


Загрузка CPU
87.3%
52–56%


Использование RAM
1.7/1.9 ГБ (89.4%)
4.3–4.7/16 ГБ (27–29%)


Дисковый I/O
6.1%
9–47%


3.3 Анализ использования ресурсов

Ubuntu:
Высокая загрузка CPU (87.3%), близкая к пределу вычислительных ресурсов.
Высокое использование памяти (89.4%), близкое к порогу подкачки.
Низкая активность диска (6.1%), без значительных узких мест.


Windows:
Низкая загрузка CPU (56%), ресурсы недоиспользуются.
Низкое использование памяти (28%), значительный запас.
Значительные колебания дискового I/O (9–47%), возможно, из-за особенностей файловой системы NTFS.



3.4 Сравнение производительности и выводы

Производительность: Ubuntu демонстрирует на 31% выше TPM и на 29% выше NOPM по сравнению с Windows, что указывает на более эффективную обработку транзакций.
Стабильность: Windows обеспечивает более стабильную нагрузку на CPU и диск, но менее эффективна.
Выбор ОС: На основе более высоких показателей TPM и NOPM для этапа 3 выбрана Ubuntu 22.04 LTS.

4 Этап 3: Тестирование оптимизации параметров виртуальной машины
4.1 Методология тестирования

Тестовая платформа: Ubuntu 22.04.4 LTS (ARM64), Parallels Desktop 19.3.0.
Переменные тестирования:
Тесты vCPU (RAM фиксирована на 4 ГБ): 2, 4, 6, 8 ядер.
Тесты RAM (vCPU фиксировано на 6 ядрах): 2, 4, 8, 16 ГБ.


Меры оптимизации:
Ядро Ubuntu:echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p


PostgreSQL:ALTER SYSTEM SET random_page_cost = 1.1;
ALTER SYSTEM SET effective_cache_size = '3GB';
ALTER SYSTEM SET shared_buffers = '2GB';
ALTER SYSTEM SET max_worker_processes = 4;


HammerDB: Очистка кэша TCL-скриптов для устранения ошибки RandomNumber.rm -rf ~/.hammerdb/cache/*





4.2 Результаты тестирования
Тесты vCPU (RAM = 4 ГБ)



Конфигурация
TPM
NOPM
Загрузка CPU
Использование RAM
Дисковый I/O
95-й персентиль задержки (мс)



2 vCPU
118,742
51,309
96.2%
1.9 ГБ/92%
8.7%
187


4 vCPU
157,896
68,472
89.7%
1.6 ГБ/84%
7.3%
159


6 vCPU
183,403
79,805
87.3%
1.7 ГБ/89.4%
6.1%
142


8 vCPU
189,621
81,947
84.8%
1.8 ГБ/91%
6.4%
138


Тесты RAM (vCPU = 6 ядер)



Конфигурация
TPM
NOPM
Загрузка CPU
Использование RAM
Дисковый I/O
95-й персентиль задержки (мс)



2 ГБ
141,328
61,253
91.4%
1.95 ГБ/97%
9.8%
204


4 ГБ
183,403
79,805
87.3%
1.7 ГБ/89.4%
6.1%
142


8 ГБ
196,814
84,612
85.9%
2.4 ГБ/30%
5.7%
134


16 ГБ
198,207
85,139
84.6%
2.9 ГБ/18%
5.5%
131


4.3 Анализ использования ресурсов

CPU: При 2 vCPU загрузка CPU достигает 96.2%, что указывает на вычислительное узкое место. При 6–8 vCPU загрузка снижается до 84.8%, но прирост производительности ограничен.
Память: При 2 ГБ RAM использование памяти достигает 97%, вызывая подкачку, что увеличивает дисковый I/O. При 8 ГБ и 16 ГБ использование снижается до 30% и 18%, устраняя давление на память.
Дисковый I/O: В целом низкий (5.5–9.8%), но при 2 ГБ RAM подкачка увеличивает I/O.

4.4 Тенденции производительности и анализ узких мест

Тенденция vCPU: От 2 до 6 vCPU TPM увеличивается на 54.5%; от 6 до 8 vCPU прирост составляет лишь 3.4%, что указывает на насыщение производительности.
Тенденция RAM: От 2 ГБ до 4 ГБ TPM увеличивается на 29.8%; от 4 ГБ до 8 ГБ — на 7.3%, а от 8 ГБ до 16 ГБ — на 0.7%, что подтверждает 8 ГБ как точку насыщения памяти.
Узкие места:
CPU: 2 vCPU ограничивают параллельную обработку; рекомендуется оптимизировать max_parallel_workers_per_gather.
Память: 2 ГБ вызывают подкачку; 8 ГБ и выше устраняют это ограничение.
Дисковый I/O: Не является основным ограничением, но при низком объеме RAM подкачка увеличивает нагрузку.



4.5 Определение оптимальной конфигурации

Оптимальная конфигурация: 6 vCPU / 8 ГБ RAM.
Производительность:
TPM: 196,814 (на 7.3% выше базовой).
NOPM: 84,612 (на 6.0% выше базовой).
Задержка: 134 мс (значительно лучше требования TPC-C ≤200 мс).


Использование ресурсов:
CPU: 85.9% (эффективно).
Память: 2.4 ГБ/30% (значительный запас).
Дисковый I/O: 5.7% (низкая нагрузка).


Обоснование: Эта конфигурация обеспечивает баланс между производительностью и эффективностью ресурсов, идеально подходит для высоконагруженных OLTP-систем.

5 Выводы и рекомендации
5.1 Общие выводы

Этап 2: Ubuntu 22.04 LTS демонстрирует на ~30% более высокие показатели TPM и NOPM по сравнению с Windows 11, но с более высокой загрузкой CPU и близким к лимиту использованием памяти.
Этап 3: Оптимизация vCPU и RAM повысила производительность Ubuntu; конфигурация 6 vCPU / 8 ГБ RAM обеспечивает оптимальную производительность (TPM 196,814, NOPM 84,612), удовлетворяя требованиям высоконагруженных систем.
Технические выводы: Эксперимент подтвердил превосходство Ubuntu для задач PostgreSQL в виртуализированной среде; оптимизация ресурсов значительно улучшила производительность.

5.2 Рекомендации для производственной среды

Конфигурация: Использовать 6 vCPU / 8 ГБ RAM с NVMe-дисками.
Оптимизация PostgreSQL:ALTER SYSTEM SET work_mem = '8MB';
ALTER SYSTEM SET checkpoint_timeout = '15min';


Мониторинг: Регулярно проверять логи PostgreSQL, автоматизировать очистку кэша HammerDB.

5.3 Направления будущих тестов

Тестирование с увеличенным числом виртуальных пользователей (6–8) для моделирования экстремальных нагрузок.
Сравнение влияния дисков NVMe и SATA на производительность I/O.
Исследование эффективности увеличения max_parallel_workers для полного использования многоядерных CPU.

6 Список литературы

Официальная документация HammerDB: https://www.hammerdb.com/docs/
Документация PostgreSQL 16: https://www.postgresql.org/docs/16/
Руководство пользователя Parallels Desktop: https://www.parallels.com/products/desktop/resources/

7 Приложения

Конфигурационный снимок: См. раздел документирования этапа 1.
Логи тестирования: Путь к логам PostgreSQL: /var/log/postgresql/postgresql-16-main.log.
Скрипты HammerDB: Стандартный шаблон TPROC-C, команда очистки кэша:rm -rf ~/.hammerdb/cache/*



