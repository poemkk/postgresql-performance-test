# Этап 3: Отчет о тестировании производительности PostgreSQL (Ubuntu 22.04 LTS, ARM64)

## 1. Введение

### 1.1 Предпосылки
На этапе 2 было проведено сравнение производительности PostgreSQL 16.8 на платформах Ubuntu 22.04 LTS и Windows 11 (ARM64). Результаты показали значительное преимущество Ubuntu:
- **TPM (транзакций в минуту)**: Ubuntu — 183,403, Windows — 140,000 (+31%).
- **NOPM (новых заказов в минуту)**: Ubuntu — 79,805, Windows — 62,000 (+29%).
- Производительность Ubuntu на 22% превысила минимальные требования TPC-C, тогда как Windows оказалась ниже стандарта.

На основании этих данных для этапа 3 была выбрана платформа **Ubuntu 22.04 LTS**. Целью стало исследование влияния параметров виртуальной машины (ВМ), таких как количество vCPU и объем оперативной памяти (RAM), на производительность PostgreSQL, а также определение оптимальной конфигурации для высоконагруженных систем обработки транзакций (OLTP).

### 1.2 Цели
- Оценить влияние количества vCPU (2, 4, 6, 8 ядер) и объема RAM (2, 4, 8, 16 ГБ) на производительность PostgreSQL.
- Проанализировать взаимосвязь между метриками производительности (TPM, NOPM) и использованием ресурсов (ЦП, память, дисковый ввод-вывод).
- Определить оптимальную конфигурацию ВМ, обеспечивающую высокую производительность при рациональном использовании ресурсов.

---

## 2. Методология эксперимента

### 2.1 Тестовая среда
| **Компонент**           | **Характеристики**                         |
| ----------------------- | ------------------------------------------ |
| Платформа виртуализации | Parallels Desktop 19.3.0                   |
| Операционная система    | Ubuntu 22.04.4 LTS (ARM64)                 |
| Версия PostgreSQL       | 16.8                                       |
| Базовая конфигурация ВМ | 6 vCPU, 4 ГБ RAM, 64 ГБ SSD (динамический) |
| Версия HammerDB         | 0.42 (нагрузка TPROC-C)                    |

### 2.2 Параметры тестирования
**Конфигурация HammerDB TPROC-C** (идентична этапу 2 для сопоставимости):
```ini
[TPROC-C Profile]
Virtual Users = 4
Rampup Time = 120 sec
Duration = 600 sec
Warehouses = 10
Think Time = 5000ms
```

**Меры оптимизации** (на основе рекомендаций этапа 2):
- **Оптимизация ядра Ubuntu**: Снижение склонности к использованию swap для улучшения управления памятью.
  ```bash
  echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
  sudo sysctl -p
  ```
- **Конфигурация PostgreSQL**: Настройка кэша и параметров параллельной обработки для повышения эффективности запросов.
  ```sql
  ALTER SYSTEM SET random_page_cost = 1.1;
  ALTER SYSTEM SET effective_cache_size = '3GB';
  ALTER SYSTEM SET shared_buffers = '2GB';
  ALTER SYSTEM SET max_worker_processes = 4;
  ```
- **Оптимизация HammerDB**: Очистка кэша TCL-скриптов для устранения ошибки `RandomNumber`, выявленной на этапе 2.
  ```bash
  rm -rf ~/.hammerdb/cache/*
  ```

### 2.3 Конфигурации тестирования
Эксперимент состоял из двух групп тестов с изменением одного параметра:
1. **Тесты vCPU** (RAM зафиксирована на 4 ГБ):
   - 2 vCPU
   - 4 vCPU
   - 6 vCPU 
   - 8 vCPU 
2. **Тесты RAM** (vCPU зафиксировано на 6 ядрах):
   - 2 ГБ
   - 4 ГБ 
   - 8 ГБ
   - 16 ГБ 

**Примечания**:
- Изменялся только один параметр за раз для контроля переменных.
- Каждая конфигурация тестировалась 3 раза, результаты усреднялись для повышения надежности.
- Хост — архитектура ARM64, предположительно 8 ядер и 32 ГБ памяти, что достаточно для всех тестов.

### 2.4 Мониторинг и сбор данных
- **Метрики производительности**: TPM, NOPM, 95-й процентиль задержки.
- **Использование ресурсов**: ЦП (% user + % system), память (ГБ и %), дисковый ввод-вывод (% wa).
- **Инструменты**:
  - `top` и `htop`: мониторинг ресурсов в реальном времени.
  - HammerDB: вывод метрик производительности.
  - Журнал PostgreSQL (`/var/log/postgresql/postgresql-16-main.log`): фиксация ошибок.

---

## 3. Результаты тестирования

### 3.1 Результаты тестов vCPU (RAM = 4 ГБ)
| Конфигурация  | TPM     | NOPM   | Использование ЦП (%) | Использование памяти (ГБ/%) | Дисковый ввод-вывод (% wa) | 95-й процентиль задержки (мс) |
| ------------- | ------- | ------ | -------------------- | --------------------------- | -------------------------- | ----------------------------- |
| 2 vCPU / 4 ГБ | 118,742 | 51,309 | 96.2                 | 1.9 / 92%                   | 8.7                        | 187                           |
| 4 vCPU / 4 ГБ | 157,896 | 68,472 | 89.7                 | 1.6 / 84%                   | 7.3                        | 159                           |
| 6 vCPU / 4 ГБ | 183,403 | 79,805 | 87.3                 | 1.7 / 89.4%                 | 6.1                        | 142                           |
| 8 vCPU / 4 ГБ | 189,621 | 81,947 | 84.8                 | 1.8 / 91%                   | 6.4                        | 138                           |

### 3.2 Результаты тестов RAM (vCPU = 6 ядер)
| Конфигурация   | TPM     | NOPM   | Использование ЦП (%) | Использование памяти (ГБ/%) | Дисковый ввод-вывод (% wa) | 95-й процентиль задержки (мс) |
| -------------- | ------- | ------ | -------------------- | --------------------------- | -------------------------- | ----------------------------- |
| 6 vCPU / 2 ГБ  | 141,328 | 61,253 | 91.4                 | 1.95 / 97%                  | 9.8                        | 204                           |
| 6 vCPU / 4 ГБ  | 183,403 | 79,805 | 87.3                 | 1.7 / 89.4%                 | 6.1                        | 142                           |
| 6 vCPU / 8 ГБ  | 196,814 | 84,612 | 85.9                 | 2.4 / 30%                   | 5.7                        | 134                           |
| 6 vCPU / 16 ГБ | 198,207 | 85,139 | 84.6                 | 2.9 / 18%                   | 5.5                        | 131                           |

### 3.3 Анализ использования ресурсов
- **ЦП**: При 2 vCPU использование ЦП достигло 96.2%, что указывает на ограничение вычислительных ресурсов и узкое место. С увеличением числа ядер до 8 использование снизилось до 84.8%, демонстрируя улучшение параллельной обработки. Однако прирост производительности от 6 до 8 vCPU был незначительным, что свидетельствует о приближении к насыщению.
- **Память**: Конфигурация с 2 ГБ RAM показала использование 97%, что вызвало операции подкачки (swap), увеличив дисковый ввод-вывод до 9.8% и задержки. Конфигурация с 4 ГБ близка к пределу (89.4%), тогда как 8 ГБ и 16 ГБ используют лишь 30% и 18% соответственно, полностью устраняя давление на память.
- **Дисковый ввод-вывод**: В целом низкий (5.5–9.8%), но при 2 ГБ RAM подкачка увеличила ввод-вывод, что отрицательно сказалось на производительности. При 8 ГБ и 16 ГБ ввод-вывод минимален (5.5–5.7%), что отражает эффективное управление памятью.

**Взаимодействие ресурсов**: Недостаток памяти (2 ГБ) ограничивает кэш базы данных (`shared_buffers`), вызывая подкачку, которая увеличивает нагрузку на ввод-вывод и косвенно нагружает ЦП. Увеличение RAM (8 ГБ и выше) устраняет эту цепную реакцию, повышая общую производительность.

---

## 4. Анализ и обсуждение

### 4.1 Тенденции производительности
На основе данных HammerDB были построены следующие графики:

**Рисунок 1: Влияние vCPU на TPM и NOPM**
- **Тенденция**: TPM увеличился с 118,742 (2 vCPU) до 183,403 (6 vCPU), что составляет рост на 54.5%, отражая значительное улучшение параллельной обработки. Однако от 6 до 8 vCPU прирост составил лишь 3.4% (189,621), что указывает на приближение к точке насыщения производительности.

- **Причина**: Рабочие процессы PostgreSQL (`max_worker_processes=4`) полностью используют ресурсы ЦП при 6 vCPU, а дополнительные ядра дают минимальный прирост.

  <img width="809" alt="image" src="https://github.com/user-attachments/assets/665aaac6-0f16-4d3c-9906-936730cb2edb" />


**Рисунок 2: Влияние RAM на TPM и NOPM**
- **Тенденция**: TPM вырос с 141,328 (2 ГБ) до 183,403 (4 ГБ) на 29.8%, что свидетельствует об устранении узкого места кэширования. От 4 ГБ до 8 ГБ прирост составил 7.3% (196,814), а от 8 ГБ до 16 ГБ — всего 0.7% (198,207), что подтверждает 8 ГБ как точку насыщения памяти.

- **Причина**: Объем 8 ГБ полностью удовлетворяет настройки `shared_buffers` (2 ГБ) и `effective_cache_size` (3 ГБ), а дополнительная память (16 ГБ) остается неиспользованной.

  <img width="849" alt="image" src="https://github.com/user-attachments/assets/fa14de3b-52d3-4435-8cbc-d966804a0e6f" />


**Рисунок 3: Сравнение TPM для vCPU и RAM**

- **Тенденция**: TPM в тестах RAM при высоких конфигурациях (8 ГБ и выше) незначительно превосходит тесты vCPU (8 vCPU), что подчеркивает чуть большее влияние оптимизации памяти на производительность.

- **Причина**: Память напрямую влияет на частоту попаданий в кэш базы данных, тогда как ЦП ограничен количеством рабочих процессов.

  <img width="829" alt="image" src="https://github.com/user-attachments/assets/885dddeb-a52a-405a-9047-52ddc35e2cdc" />

  

**Рисунок 4: Сравнение NOPM для vCPU и RAM**
- **Тенденция**: Тенденции NOPM аналогичны TPM, с небольшим преимуществом тестов RAM при высоких конфигурациях, но разрыв минимален.

- **Причина**: NOPM больше зависит от эффективности обработки транзакций, где влияние памяти и ЦП сбалансировано.

  <img width="840" alt="image" src="https://github.com/user-attachments/assets/1b7d54fe-bbaf-4ecc-b38f-558fcf0e81b4" />


### 4.2 Анализ узких мест
- **Узкое место ЦП**: При 2 vCPU использование ЦП на уровне 96.2% ограничивает параллельную обработку транзакций. Конфигурации с 6–8 vCPU устраняют это ограничение, но прирост производительности замедляется. Рекомендуется оптимизировать `max_parallel_workers_per_gather` для более эффективного использования многоядерных систем.
- **Узкое место памяти**: При 2 ГБ RAM использование памяти достигает 97%, вызывая подкачку, что увеличивает ввод-вывод и задержки. Конфигурация с 8 ГБ устраняет это узкое место. Рекомендуется увеличить `work_mem` (например, до 8 МБ) для поддержки сложных запросов.
- **Дисковый ввод-вывод**: В целом низкий, не является основным ограничением. Однако при 2 ГБ RAM подкачка увеличивает ввод-вывод, что требует использования NVMe-дисков в производственной среде для минимизации потенциальных проблем.

**Рекомендации по оптимизации**:
- Увеличить `work_mem` и `maintenance_work_mem` для повышения эффективности запросов и задач обслуживания.
- Продлить `checkpoint_timeout` (например, до 15 минут) для снижения нагрузки на ввод-вывод от контрольных точек.
- При сохранении узкого места ЦП рассмотреть увеличение `max_worker_processes` (например, до 6), но с мониторингом потребностей памяти.

### 4.3 Оптимальная конфигурация
С учетом производительности и использования ресурсов оптимальной признана конфигурация **6 vCPU / 8 ГБ RAM**:
- **TPM**: 196,814 (на 7.3% выше базовой).
- **NOPM**: 84,612 (на 6.0% выше базовой).
- **Использование ресурсов**:
  - ЦП: 85.9% (эффективно, без насыщения).
  - Память: 2.4 ГБ / 30% (значительный запас).
  - Дисковый ввод-вывод: 5.7% (низкая нагрузка).
- **Задержка**: 134 мс (значительно лучше требования TPC-C ≤200 мс).

Эта конфигурация обеспечивает оптимальный баланс между производительностью и эффективностью ресурсов, идеально подходя для высоконагруженных OLTP-систем.

---

## 5. Выводы и рекомендации

### 5.1 Выводы
Эксперимент подтвердил превосходство Ubuntu 22.04 LTS над Windows 11 для задач PostgreSQL, демонстрируя более высокую производительность и эффективность. Тестирование vCPU и RAM выявило ключевые аспекты влияния ресурсов:
- 6 vCPU представляет собой точку баланса между производительностью и вычислительными ресурсами, тогда как 8 vCPU дают ограниченный прирост, отражая снижение предельной эффективности параллельной обработки.
- 8 ГБ RAM обеспечивают оптимальную конфигурацию памяти, а 16 ГБ избыточны, что указывает на насыщение потребностей кэширования.
- Оптимальная конфигурация (6 vCPU / 8 ГБ RAM) достигла TPM 196,814 и NOPM 84,612, что удовлетворяет требованиям высоконагруженных OLTP-систем и на ~7% превосходит базовые показатели этапа 2.

По сравнению с этапом 2, этап 3 благодаря оптимизации ресурсов повысил производительность, подтвердив пригодность Ubuntu для производственных сред и предоставив данные для дальнейшего развертывания.

### 5.2 Рекомендации
1. **Развертывание в производственной среде**:
   - Использовать конфигурацию **6 vCPU / 8 ГБ RAM** для достижения баланса производительности и затрат.
   - Оптимизировать параметры PostgreSQL, например, увеличить `work_mem` до 8 МБ и продлить `checkpoint_timeout` до 15 минут для повышения эффективности сложных запросов и контрольных точек.
   - Применять NVMe-диски для минимизации потенциальных узких мест ввода-вывода.
2. **Направления дальнейших тестов**:
   - Исследовать сценарии с большим числом виртуальных пользователей (6–8) для моделирования экстремальных нагрузок.
   - Оценить влияние типа дисков (NVMe против SATA) на производительность ввода-вывода.
   - Проверить эффективность увеличения `max_parallel_workers` для более полного использования многоядерных ЦП.
3. **Мониторинг и обслуживание**:
   - Постоянно отслеживать использование памяти и ЦП, избегая конфигураций с 2 ГБ RAM или 2 vCPU из-за их узких мест.
   - Регулярно проверять журналы PostgreSQL для исключения ошибок TCL-скриптов и других аномалий.
   - Автоматизировать очистку кэша HammerDB для предотвращения повторения ошибки `RandomNumber` с этапа 2.

