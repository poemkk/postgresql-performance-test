# Этап 1: Выбор инструментов, установка и начальная конфигурация

------

## 1. Введение

Этап 1 направлен на создание стандартизированной среды для последующих нагрузочных тестов путем выбора подходящей платформы виртуализации, системы управления базами данных (СУБД) и операционных систем виртуальных машин. Настоящий документ подробно описывает выбор инструментов, процесс установки и начальную конфигурацию, обеспечивая согласованность и воспроизводимость тестирования.

------

## 2. Выбор платформы виртуализации

### 2.1 Выбор

- **Основной вариант**: Parallels Desktop 19.3.0 (версия для ARM).
- **Альтернатива**: UTM 4.4 (решение с открытым исходным кодом).

### 2.2 Обоснование выбора

- Parallels Desktop обеспечивает оптимизированную производительность виртуализации на архитектуре ARM, адаптированную для чипов Apple M-series.
- Полная поддержка инструментов Guest Additions для виртуальных машин Windows и Linux, упрощающая интеграцию.
- Oracle VirtualBox имеет низкую совместимость с Apple Silicon, что исключает его использование.

### 2.3 Конфигурация хоста и версии

```markdown
- Платформа виртуализации: Parallels Desktop 19.3.0 (ARM)
- Хост:
  - ОС: macOS 15.4.1 (Sonoma)
  - Процессор: Apple M2 Pro (12 ядер CPU, 19 ядер GPU)
  - Память: 32 ГБ Unified Memory
  - Хранилище: 1 ТБ SSD (NVMe)
```

------

## 3. Выбор СУБД

### 3.1 Выбор

- **СУБД**: PostgreSQL 16.8 (ARM64).

### 3.2 Обоснование выбора

1. **Кроссплатформенная согласованность**: стабильная работа в средах Windows и Linux.
2. **Диагностика производительности**: мощные встроенные инструменты мониторинга и оптимизации.
3. **Поддержка ARM**: нативная совместимость с архитектурой ARM, идеально для Apple Silicon.

### 3.3 Контроль версий

```bash
PostgreSQL 16.8 (ARM64)
```

------

## 4. Выбор операционных систем виртуальных машин

### 4.1 Конфигурация

| Параметр        | Виртуальная машина Linux   | Виртуальная машина Windows |
| --------------- | -------------------------- | -------------------------- |
| **Версия**      | Ubuntu 22.04.4 LTS (ARM64) | Windows 11 23H2 (ARM64)    |
| **Разрядность** | 64-bit                     | 64-bit                     |
| **Особенности** | Минимальная установка      | Режим разработчика         |

### 4.2 Обоснование выбора

- **Ubuntu 22.04.4 LTS**: версия с долгосрочной поддержкой, стабильная и с минимальным потреблением ресурсов, подходит для серверных задач.
- **Windows 11 23H2**: поддерживает ARM-архитектуру, режим разработчика упрощает тестирование и отладку.

------

## 5. Создание и настройка виртуальных машин

### 5.1 Аппаратные параметры

Для обеспечения справедливого тестирования обе виртуальные машины настроены с идентичными начальными параметрами:

```markdown
- vCPU: 2 ядра
- Память: 4 ГБ DDR5
- Диск:
  - Тип: динамический
  - Объем: 64 ГБ
- Сеть: режим моста
```

### 5.2 Установка дополнений

- **Ubuntu**:

  ```bash
  sudo apt update
  sudo apt install parallels-tools
  ```

- **Windows**:

  ```plaintext
  Автоматическая установка Parallels Tools
  ```

### 5.3 Проверка конфигурации

- Подтверждено: сеть виртуальных машин доступна в режиме моста.
- Проверено: функции Guest Additions (общий буфер обмена, адаптация экрана) работают корректно.

------

## 6. Установка и настройка PostgreSQL

### 6.1 Процесс установки

- **Ubuntu**:

  ```bash
  sudo apt update
  sudo apt install postgresql-16
  sudo systemctl enable postgresql
  sudo systemctl start postgresql
  ```

- **Windows**:

  ```bash
  choco install postgresql16
  ```

### 6.2 Проверка установки

- Выполнение команды для подтверждения версии:

  ```sql
  SELECT version(); -- Ожидаемый результат: PostgreSQL 16.8 on arm64
  ```

- Проверка статуса службы:

  - **Ubuntu**: `sudo systemctl status postgresql`
  - **Windows**: подтверждение работы службы PostgreSQL через диспетчер служб.

### 6.3 Настройка сетевого доступа

- Настройка PostgreSQL для удаленного подключения:

  - Редактирование `postgresql.conf`:

    ```plaintext
    listen_addresses = '*'
    
    ```

  - Редактирование `pg_hba.conf`, добавление:

    ```plaintext
    host all all 0.0.0.0/0 md5
    
    ```

  - Перезапуск службы:

    ```bash
    sudo systemctl restart postgresql  # Ubuntu
    net stop postgresql-x64-16 && net start postgresql-x64-16  # Windows
    
    ```

------

## 7. Установка и настройка HammerDB

### 7.1 Установка

- **Версия**: HammerDB 4.10 (macOS).
- **Место установки**: хостовая система macOS.
- **Шаги**:
  1. Загрузка установочного пакета HammerDB 4.10.
  2. Распаковка и настройка переменных окружения для запуска HammerDB.

### 7.2 Настройка

- **Тестовый скрипт**: TPROC-C (стандартный шаблон OLTP).

- **Ключевые параметры**:

  ```ini
  [Database]
  Connection Timeout=60000
  
  [Virtual Users]
  Count=8
  Rampup=120
  
  ```

- **Проверка**:

  - Успешное подключение к экземплярам PostgreSQL на виртуальных машинах Ubuntu и Windows.
  - Выполнение скрипта построения TPROC-C, подтверждение корректного создания схемы базы данных.

### 7.3 Справочная документация

- Официальная документация HammerDB (раздел TPROC-C) использована для настройки и проведения тестов.

------

## 8. Документирование конфигурации

### 8.1 Базовый конфигурационный снимок

```markdown
Дата: 16 мая 2025 г.

#### Аппаратные параметры
| Компонент       | Хост       | Виртуальная машина Ubuntu | Виртуальная машина Windows |
|-----------------|------------|--------------------------|--------------------------|
| Архитектура     | ARM64      | ARM64                    | ARM64                    |

#### Версии ПО
- Платформа виртуализации: Parallels Desktop 19.3.0
- СУБД: PostgreSQL 16.8
- Ubuntu: 22.04.4 LTS
- Windows: 11 23H2
- HammerDB: 4.10

```

------

## 9. Замечания и оптимизация

### 9.1 Требования для Apple Silicon

1. **Образы ARM**: использовать только образы операционных систем ARM64.
2. **Отключение Rosetta**: избегать использования слоя совместимости Rosetta для максимальной производительности.

### 9.2 Оптимизация системы

- **Ubuntu**:

  ```bash
  echo "vm.swappiness = 1" | sudo tee -a /etc/sysctl.conf
  sudo sysctl -p
  
  ```

- **Windows**:

  ```bash
  powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
  
  ```

### 9.3 Подготовка к тестированию

- **Снимки системы**: создавать снимки виртуальных машин перед каждым тестом для возможности восстановления.
- **Согласованность**: строго контролировать версии ПО и параметры конфигурации для обеспечения сравнимости результатов.
- **Логирование**: включить журналирование PostgreSQL, пути к логам:
  - Ubuntu: `/var/log/postgresql/postgresql-16-main.log`
  - Windows: каталог `data/pg_log` в директории установки.

------

## 10. Выводы

На данном этапе завершены выбор и настройка платформы виртуализации, СУБД, операционных систем виртуальных машин и инструмента нагрузочного тестирования. Создана стандартизированная тестовая среда, оптимизированная для оборудования Apple Silicon, с акцентом на согласованность версий и высокую производительность. Последующие этапы будут основаны на этой среде для проведения тестов производительности и оптимизации.
